<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance Dashboard</title>

  <!-- Chart.js for analytics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { 
      getFirestore, collection, onSnapshot, orderBy, query, addDoc, where, getDocs 
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
    import { 
      getAuth, onAuthStateChanged, signOut 
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

    // ====== Firebase Config ======
    const firebaseConfig = {
      apiKey: "AIzaSyDZMEJ6ALhKRZ-Bv3tmQ71TSnIZd89prow",
      authDomain: "attendace-9d237.firebaseapp.com",
      projectId: "attendace-9d237",
      storageBucket: "attendace-9d237.firebasestorage.app",
      messagingSenderId: "248211930711",
      appId: "1:248211930711:web:88e178f5d0323e88966d12"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ====== Auth Check ======
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "admin.html";
      } else {
        document.getElementById("adminEmail").textContent = user.email;
        loadAttendance();
      }
    });

    // ====== Logout ======
    window.logoutAdmin = function () {
      signOut(auth).then(() => window.location.href = "admin.html");
    };

    // ====== Load Attendance Data ======
    let allData = [];
    function loadAttendance() {
      const sortOrder = document.getElementById("sortOrder")?.value || "desc";
      const q = query(collection(db, "attendance"), orderBy("timestamp", sortOrder));

      onSnapshot(q, (snapshot) => {
        allData = [];
        snapshot.forEach((doc) => {
          allData.push({ id: doc.id, ...doc.data() });
        });
        renderTable(allData);
        updateSummary(allData);
        updateChart(allData);
      });
    }

    // ====== Render Table ======
    function renderTable(data) {
      const tableBody = document.getElementById("attendanceBody");
      const countDisplay = document.getElementById("count");
      tableBody.innerHTML = "";
      let count = 0;

      data.forEach((item) => {
        const dateObj = item.timestamp?.toDate ? item.timestamp.toDate() : new Date();
        const date = dateObj.toLocaleDateString();
        const time = dateObj.toLocaleTimeString();
        const status = checkLate(dateObj) ? "Late ‚è∞" : "Present ‚úÖ";
        const row = `
          <tr>
            <td>${++count}</td>
            <td>${item.name}</td>
            <td>${item.role}</td>
            <td>${item.class || "‚Äî"}</td>
            <td>${date}</td>
            <td>${time}</td>
            <td>${status}</td>
          </tr>`;
        tableBody.innerHTML += row;
      });

      countDisplay.textContent = count;
    }

    // ====== Check for Lateness ======
    function checkLate(dateObj) {
      const limit = new Date(dateObj);
      limit.setHours(8, 15, 0); // 8:15 AM limit
      return dateObj.getHours() > 8 || (dateObj.getHours() === 8 && dateObj.getMinutes() > 15);
    }

    // ====== Search Filter ======
    window.filterSearch = function () {
      const term = document.getElementById("searchBox").value.toLowerCase();
      const filtered = allData.filter(d => d.name?.toLowerCase().includes(term));
      renderTable(filtered);
    };

    // ====== Summary Counts ======
    function updateSummary(data) {
      const total = data.length;
      const students = data.filter(d => d.role === "Student").length;
      const teachers = data.filter(d => d.role === "Teacher").length;
      document.getElementById("count").textContent = total;
      document.getElementById("summary").textContent =
        `Students: ${students} | Teachers: ${teachers}`;
    }

    // ====== Chart ======
    function updateChart(data) {
      const ctx = document.getElementById("attendanceChart").getContext("2d");
      const grouped = {};

      data.forEach((d) => {
        const date = d.timestamp?.toDate().toLocaleDateString();
        grouped[date] = (grouped[date] || 0) + 1;
      });

      const labels = Object.keys(grouped);
      const values = Object.values(grouped);

      if (window.attChart) window.attChart.destroy();
      window.attChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Attendance Count",
            data: values,
            backgroundColor: "#0078d7"
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // ====== Export to CSV ======
    window.exportToCSV = function () {
      const rows = [["#", "Full Name", "Role", "Class", "Date", "Time", "Status"]];
      const trs = document.querySelectorAll("#attendanceBody tr");
      trs.forEach((tr) => {
        const cells = Array.from(tr.children).map(td => td.innerText);
        rows.push(cells);
      });

      const csvContent = "data:text/csv;charset=utf-8," +
        rows.map(e => e.join(",")).join("\n");

      const link = document.createElement("a");
      link.setAttribute("href", encodeURI(csvContent));
      link.setAttribute("download", "attendance_records.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    // ====== Export to PDF ======
    window.exportToPDF = async function () {
      const { jsPDF } = await import("https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.es.min.js");
      const doc = new jsPDF();
      doc.text("Attendance Report", 14, 20);
      let y = 30;
      allData.forEach((d, i) => {
        const date = d.timestamp?.toDate().toLocaleDateString();
        doc.text(`${i + 1}. ${d.name} (${d.role}) - ${date}`, 14, y);
        y += 8;
      });
      doc.save("attendance_report.pdf");
    };
  </script>

  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f4f7f9;
      padding: 20px;
      color: #333;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    h1 {
      margin: 0;
      color: #0078d7;
    }
    button, select, input {
      padding: 8px 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    button {
      background: #0078d7;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover { background: #005fa3; }
    .logout-btn { background: #dc3545; }
    .logout-btn:hover { background: #b02a37; }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #0078d7;
      color: white;
      cursor: pointer;
    }
    tr:hover { background: #f9f9f9; }
    .toolbar {
      margin-bottom: 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    canvas { margin-top: 30px; background: white; padding: 10px; border-radius: 10px; }
  </style>
</head>
<body>
  <header>
    <h1>üìä Attendance Dashboard</h1>
    <div>
      <span>üë§ <b id="adminEmail">Loading...</b></span>
      <button class="logout-btn" onclick="logoutAdmin()">Logout</button>
    </div>
  </header>

  <div class="toolbar">
    <label>Search: </label>
    <input id="searchBox" onkeyup="filterSearch()" placeholder="Enter name...">
    <label>Sort:</label>
    <select id="sortOrder" onchange="loadAttendance()">
      <option value="desc">Newest First</option>
      <option value="asc">Oldest First</option>
    </select>
    <button onclick="exportToCSV()">‚¨áÔ∏è Export CSV</button>
    <button onclick="exportToPDF()">üìÑ Export PDF</button>
  </div>

  <div id="summary" style="margin-bottom:10px;font-weight:bold;"></div>
  <div>Total Records: <span id="count">0</span></div>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Full Name</th>
        <th>Role</th>
        <th>Class</th>
        <th>Date</th>
        <th>Time</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="attendanceBody"></tbody>
  </table>

  <canvas id="attendanceChart" height="120"></canvas>
</body>
</html>
